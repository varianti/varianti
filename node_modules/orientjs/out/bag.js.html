<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>bag.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="global.html#Long">Long</a><ul class='methods'><li data-type='method'><a href="global.html#Long#.fromBits">fromBits</a></li><li data-type='method'><a href="global.html#Long#.fromInt">fromInt</a></li><li data-type='method'><a href="global.html#Long#.fromNumber">fromNumber</a></li><li data-type='method'><a href="global.html#Long#.fromString">fromString</a></li><li data-type='method'><a href="global.html#Long#add">add</a></li><li data-type='method'><a href="global.html#Long#and">and</a></li><li data-type='method'><a href="global.html#Long#compare">compare</a></li><li data-type='method'><a href="global.html#Long#div">div</a></li><li data-type='method'><a href="global.html#Long#equals">equals</a></li><li data-type='method'><a href="global.html#Long#getHighBits">getHighBits</a></li><li data-type='method'><a href="global.html#Long#getLowBits">getLowBits</a></li><li data-type='method'><a href="global.html#Long#getLowBitsUnsigned">getLowBitsUnsigned</a></li><li data-type='method'><a href="global.html#Long#getNumBitsAbs">getNumBitsAbs</a></li><li data-type='method'><a href="global.html#Long#greaterThan">greaterThan</a></li><li data-type='method'><a href="global.html#Long#greaterThanOrEqual">greaterThanOrEqual</a></li><li data-type='method'><a href="global.html#Long#isNegative">isNegative</a></li><li data-type='method'><a href="global.html#Long#isOdd">isOdd</a></li><li data-type='method'><a href="global.html#Long#isZero">isZero</a></li><li data-type='method'><a href="global.html#Long#lessThan">lessThan</a></li><li data-type='method'><a href="global.html#Long#lessThanOrEqual">lessThanOrEqual</a></li><li data-type='method'><a href="global.html#Long#modulo">modulo</a></li><li data-type='method'><a href="global.html#Long#multiply">multiply</a></li><li data-type='method'><a href="global.html#Long#negate">negate</a></li><li data-type='method'><a href="global.html#Long#not">not</a></li><li data-type='method'><a href="global.html#Long#notEquals">notEquals</a></li><li data-type='method'><a href="global.html#Long#or">or</a></li><li data-type='method'><a href="global.html#Long#shiftLeft">shiftLeft</a></li><li data-type='method'><a href="global.html#Long#shiftRight">shiftRight</a></li><li data-type='method'><a href="global.html#Long#shiftRightUnsigned">shiftRightUnsigned</a></li><li data-type='method'><a href="global.html#Long#subtract">subtract</a></li><li data-type='method'><a href="global.html#Long#toInt">toInt</a></li><li data-type='method'><a href="global.html#Long#toJSON">toJSON</a></li><li data-type='method'><a href="global.html#Long#toNumber">toNumber</a></li><li data-type='method'><a href="global.html#Long#toString">toString</a></li><li data-type='method'><a href="global.html#Long#xor">xor</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ArrayLike">ArrayLike</a></li><li><a href="global.html#augment">augment</a></li><li><a href="global.html#Bag">Bag</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#deprecate">deprecate</a></li><li><a href="global.html#encode">encode</a></li><li><a href="global.html#escape">escape</a></li><li><a href="global.html#extend">extend</a></li><li><a href="global.html#getOrientDbUTCDate">getOrientDbUTCDate</a></li><li><a href="global.html#jsonify">jsonify</a></li><li><a href="global.html#prepare">prepare</a></li><li><a href="global.html#readLong">readLong</a></li><li><a href="global.html#RecordID">RecordID</a></li><li><a href="global.html#requiresParens">requiresParens</a></li><li><a href="global.html#size">size</a></li><li><a href="global.html#type">type</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">bag.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

var RID = require('./recordid'),
    Long = require('./long').Long;

/**
 * # RID Bag
 *
 * A bag of Record IDs, can come in two formats:
 *
 *  * embedded - just a list of record ids.
 *  * tree based - a remote tree based data structure
 *
 * for more details on the RID Bag structure, see https://github.com/orientechnologies/orientdb/wiki/RidBag
 *
 *
 * @param {String} serialized The base64 encoded RID Bag
 */
function Bag (serialized) {
  this.serialized = serialized;
  this.uuid = null;
  this._content = [];
  this._buffer = null;
  this._type = null;
  this._offset = 0;
  this._current = -1;
  this._size = null;
  this._prefetchedRecords = null;
}

Bag.BAG_EMBEDDED = 0;
Bag.BAG_TREE = 1;

module.exports = Bag;


Object.defineProperties(Bag.prototype, {
  /**
   * The bag type.
   * @type {String}
   */
  type: {
    get: function () {
      if (this._type === null) {
        this._parse();
      }
      return this._type;
    }
  },
  /**
   * The size of the bag.
   * @type {Integer}
   */
  size: {
    get: function () {
      if (this._size === null) {
        this._parse();
      }
      return this._size;
    }
  }
});


/**
 * Parse the bag content.
 */
Bag.prototype._parse = function () {
  var buffer = new Buffer(this.serialized, 'base64'),
      mode = buffer.readUInt8(0);

  if ((mode &amp; 1) === 1) {
    this._type = Bag.BAG_EMBEDDED;
  }
  else {
    this._type = Bag.BAG_TREE;
  }

  if ((mode &amp; 2) === 2) {
    this.uuid = buffer.slice(1, 16);
    this._offset = 17;
  }
  else {
    this._offset = 1;
  }


  if (this._type === Bag.BAG_EMBEDDED) {
    this._size = buffer.readInt32BE(this._offset);
    this._offset += 4;
  }
  else {
    this._fileId = readLong(buffer, this._offset);
    this._offset += 8;
    this._pageIndex = readLong(buffer, this._offset);
    this._offset += 8;
    this._pageOffset = buffer.readInt32BE(this._offset);
    this._offset += 4;
    this._size = buffer.readInt32BE(this._offset);
    this._offset += 4;
    this._changeSize = buffer.readInt32BE(this._offset);
    this._offset += 4;
  }
  this._buffer = buffer;
};

/**
 * Return a representation of the bag that can be serialized to JSON.
 *
 * @return {Array} The JSON representation of the bag.
 */
Bag.prototype.toJSON = function () {
  if (this.type === Bag.BAG_EMBEDDED) {
    return this.all();
  }
  else {
    return undefined; // because we don't yet know how to serialize a tree bag to JSON.
  }
};

/**
 * Retrieve the next RID in the bag, or null if we're at the end.
 *
 * @return {RID|null} The next Record ID, or null.
 */
Bag.prototype.next = function () {
  var rid;
  if (!this._buffer) {
    this._parse();
  }
  if (this._type === Bag.BAG_EMBEDDED) {
    if (this._current >= this._size - 1) {
      return null;
    }
    this._current++;
    rid = this._consume();
    if (this._prefetchedRecords &amp;&amp; this._prefetchedRecords[rid]) {
      this._content.push(this._prefetchedRecords[rid]);
    }
    else {
      this._content.push(rid);
    }
    return rid;
  }
};


/**
 * Retreive all the RIDs in the bag.
 *
 * @return {RID[]} The record ids.
 */
Bag.prototype.all = function () {
  var length = this.length;
  if (this._content.length !== length) {
    while(this.next()); // jshint ignore:line
  }
  return this._content;
};

/**
 * Consume the next RID in the bag.
 *
 * @return {RID|null} The next record id, or null if the bag is exhausted.
 */
Bag.prototype._consume = function () {
  var rid;
  if (this._type === Bag.BAG_EMBEDDED) {
    if (this._offset >= this._buffer.length) {
      return null;
    }
    rid = new RID();
    rid.cluster = this._buffer.readInt16BE(this._offset);
    this._offset += 2;
    rid.position = readLong(this._buffer, this._offset);
    this._offset +=8;
    return rid;
  }
};


/**
 * Read a Long from the given buffer.
 *
 * @param  {Buffer}  buffer The buffer to read from.
 * @param  {Integer} offset The offset to start reading at.
 * @return {Number}         The Long number.
 */
function readLong (buffer, offset) {
  return Long.fromBits(
      buffer.readUInt32BE(offset + 4),
      buffer.readInt32BE(offset)
  ).toNumber();
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Mon Jul 13 2015 23:06:52 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
